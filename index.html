<!DOCTYPE html>
<html>
<head>
  <title>Produce Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body.dark { background:#1e1e1e; color:#fff; }
    .toolbar { position:sticky; top:0; z-index:1000; background:#f8f9fa; border-bottom:1px solid #e9ecef; }
    .item { margin-bottom: 12px; }
    .item-number { font-weight:600; min-width: 28px; text-align:right; display:inline-block; margin-right:6px; }
    .name-col { flex: 1 1 auto; min-width: 0; }
    .name-input { width:100%; }
    .qty-col, .unit-col { flex: 0 0 90px; max-width: 110px; }
    .btn-qty { padding: .25rem .5rem; font-size:.8rem; }
    .list-container { padding: 16px; }
  </style>
</head>
<body class="bg-light">
  <!-- Sticky toolbar -->
  <div class="toolbar">
    <div class="container py-2">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-3">
          <input id="search" type="text" class="form-control" placeholder="Search items…">
        </div>
        <div class="col-12 col-md-5">
          <div class="input-group">
            <input type="text" id="newItem" class="form-control" placeholder="Add new item name">
            <button class="btn btn-primary" onclick="addItem()">Add</button>
          </div>
        </div>
        <div class="col-12 col-md-4 d-grid d-md-flex gap-2">
          <button class="btn btn-secondary" onclick="prepareThen(sortItems)">Sort A–Z</button>
          <button class="btn btn-warning" onclick="prepareThen(resetList)">Reset</button>
          <button class="btn btn-outline-secondary" id="hideBtn" onclick="toggleHideZero()">Hide 0 Qty</button>
          <button class="btn btn-outline-danger" onclick="removeZeroQty()">Remove 0 Qty</button>
          <button class="btn btn-success" onclick="prepareThen(exportToPDF)">PDF</button>
          <button class="btn btn-dark" onclick="toggleDarkMode()">Dark</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container bg-white shadow rounded list-container mt-3">
    <h2 class="text-center mb-3 text-primary">Produce Order</h2>
    <div id="list"></div>
  </div>

  <script>
    // ---------- Data ----------
    let defaultItems = [
      { name: "Cherry Tomato", qty:"", unit:"pcs" },
      { name: "Cucumber", qty:"", unit:"pcs" },
      { name: "Tomato", qty:"", unit:"pcs" },
      { name: "Baby Spinach", qty:"", unit:"pcs" },
      { name: "Lemon", qty:"", unit:"pcs" },
      { name: "Lime", qty:"", unit:"pcs" },
      { name: "Romaine Hearts", qty:"", unit:"pcs" },
      { name: "Green Bell Pepper", qty:"", unit:"pcs" },
      { name: "Sliced Mushroom", qty:"", unit:"pcs" },
      { name: "Red Bell Pepper", qty:"", unit:"pcs" }
    ];
    let items = JSON.parse(localStorage.getItem('orderList')) || JSON.parse(JSON.stringify(defaultItems));
    let filterText = "";
    let hideZero = false;

    // ---------- Storage helpers ----------
    function saveItems(){ localStorage.setItem('orderList', JSON.stringify(items)); }
    function syncInputValues(){
      // store current DOM input values back into items
      const rows = document.querySelectorAll('.item[data-index]');
      rows.forEach(row => {
        const actualIndex = parseInt(row.getAttribute('data-actual-index'));
        if (Number.isNaN(actualIndex) || !items[actualIndex]) return;
        const name = row.querySelector('.name-input')?.value ?? '';
        const qty  = row.querySelector('.qty-input')?.value ?? '';
        const unit = row.querySelector('.unit-select')?.value ?? 'pcs';
        items[actualIndex].name = name.trim();
        items[actualIndex].qty  = qty;
        items[actualIndex].unit = unit;
      });
      saveItems();
    }
    function prepareThen(fn){ syncInputValues(); fn(); }

    // ---------- Filters ----------
    function isZeroQty(q){
      // treat empty or "0" (any amount of spaces) as zero; "0.0" also zero
      const s = String(q ?? "").trim();
      if (s === "") return true;
      const n = Number(s);
      return !isNaN(n) && n === 0;
    }

    // ---------- UI ----------
    function renderList(){
      const list = document.getElementById('list');
      list.innerHTML = "";
      const q = filterText.trim().toLowerCase();

      let mapped = items.map((it, i)=>({it, i}));
      if (q) mapped = mapped.filter(x => x.it.name.toLowerCase().includes(q));
      if (hideZero) mapped = mapped.filter(x => !isZeroQty(x.it.qty));

      mapped.forEach(({it, i}, idx) => {
        const number = idx + 1;
        const row = document.createElement('div');
        row.className = "item d-flex align-items-center gap-2 flex-wrap";
        row.setAttribute('data-index', idx);
        row.setAttribute('data-actual-index', i);
        row.innerHTML = `
          <span class="item-number">${number}.</span>
          <div class="name-col">
            <input class="form-control name-input" type="text" value="${escapeHtml(it.name)}" placeholder="Item name">
          </div>
          <div class="qty-col">
            <input class="form-control form-control-sm qty-input" type="number" value="${it.qty ?? ''}" placeholder="Qty">
          </div>
          <div class="unit-col">
            <select class="form-select form-select-sm unit-select">
              <option value="pcs"   ${it.unit==="pcs"?"selected":""}>pcs</option>
              <option value="bunch" ${it.unit==="bunch"?"selected":""}>bunch</option>
              <option value="case"  ${it.unit==="case"?"selected":""}>case</option>
              <option value="box"   ${it.unit==="box"?"selected":""}>box</option>
              <option value="g"     ${it.unit==="g"?"selected":""}>g</option>
            </select>
          </div>
          <div class="d-flex gap-1">
            <button class="btn btn-outline-secondary btn-qty" onclick="nudgeQty(${i},1)">+1</button>
            <button class="btn btn-outline-secondary btn-qty" onclick="nudgeQty(${i},5)">+5</button>
            <button class="btn btn-outline-secondary btn-qty" onclick="nudgeQty(${i},10)">+10</button>
            <button class="btn btn-outline-secondary btn-qty" onclick="clearQty(${i})">Clr</button>
          </div>
        `;
        list.appendChild(row);
      });

      // update toggle button label
      document.getElementById('hideBtn').textContent = hideZero ? "Show 0 Qty" : "Hide 0 Qty";
    }

    // Prevent HTML injection in names
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ---------- Fast entry helpers ----------
    function nudgeQty(actualIndex, delta){
      syncInputValues();
      const cur = parseFloat(items[actualIndex].qty || "0") || 0;
      const next = Math.max(0, cur + delta);
      items[actualIndex].qty = String(next);
      saveItems();
      renderList();
    }
    function clearQty(actualIndex){
      syncInputValues();
      items[actualIndex].qty = "";
      saveItems();
      renderList();
    }

    // ---------- Actions ----------
    function addItem(){
      const input = document.getElementById('newItem');
      const name = (input.value || "").trim();
      if(!name) return;
      // duplicate guard (case-insensitive)
      const exists = items.some(it => it.name.toLowerCase() === name.toLowerCase());
      if (exists){ alert("Item already exists."); input.value=""; return; }
      items.push({ name, qty:"", unit:"pcs" });
      input.value = "";
      saveItems();
      renderList();
    }
    function sortItems(){
      items.sort((a,b)=> a.name.localeCompare(b.name));
      saveItems();
      renderList();
    }
    function resetList(){
      if(!confirm("Reset to default items?")) return;
      items = JSON.parse(JSON.stringify(defaultItems));
      saveItems();
      renderList();
    }
    function toggleHideZero(){
      prepareThen(()=>{ hideZero = !hideZero; renderList(); });
    }
    function removeZeroQty(){
      prepareThen(()=>{
        const before = items.length;
        items = items.filter(it => !isZeroQty(it.qty));
        const removed = before - items.length;
        saveItems();
        renderList();
        if (removed > 0) alert(`Removed ${removed} item(s) with 0 quantity.`);
      });
    }
    async function exportToPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const today = new Date().toLocaleString();
      doc.setFontSize(14); doc.text("Produce Order", 20, 20);
      doc.setFontSize(10); doc.text(`Exported on: ${today}`, 20, 26);
      let y = 40;

      // Always exclude zero-quantity from export
      const q = filterText.trim().toLowerCase();
      let filtered = q ? items.filter(it => it.name.toLowerCase().includes(q)) : items;
      filtered = filtered.filter(it => !isZeroQty(it.qty));

      filtered.forEach((it, idx) => {
        const line = `${idx+1}. ${it.name}: ${it.qty} ${it.unit || ""}`.trim();
        doc.text(line, 20, y); y += 8;
        if (y > 280){ doc.addPage(); y = 20; }
      });
      doc.save("Produce_Order_List.pdf");
    }
    function toggleDarkMode(){ document.body.classList.toggle("dark"); }

    // ---------- Search ----------
    document.getElementById('search').addEventListener('input', (e)=>{
      filterText = e.target.value || "";
      renderList();
    });

    // Initial render
    renderList();
  </script>
</body>
</html>
